<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Text Textures</title>
  </head>

  <body>

    <div id="output">webR is starting, please wait...</div>
    <button id="reset" style="display: none;">reset</button>

    <script>
      // import the webr module and then run the code
      import('https://webr.r-wasm.org/latest/webr.mjs').then(async ({WebR}) => {

        // wait for the R session to start
        console.log("initialising R session")
        const webR = new WebR();
        await webR.init();
        console.log("R session has started")

        // 1. read the source code as a javascript string
        // 2. evaluate the source code in R to return a function
        // 3. call the R function
        // 4. update document
        let art_src = fetch('art.R').then((response) => {return response.text()});  
        let art_fun = await webR.evalR(await art_src);     
        let art = await art_fun();
        document.getElementById("output").innerHTML = art.values;

        // reveal the reset button
        document.getElementById("reset").style = "display: block";
        document.getElementById("reset").onclick = async function() {
          let art = await webR.evalR('make_art()');
          art = await art.toJs();
          document.getElementById("output").innerHTML = art.values;
        }

        async function update() {
          let art_str = document.getElementById("output").innerHTML
          await webR.objs.globalEnv.bind('str', art_str)
          let art = await webR.evalR('make_art(str)');
          art = await art.toJs();
          document.getElementById("output").innerHTML = art.values;
        }

        setInterval(update, 500)        

      });
    </script>
    
    <!-- Plausible -->
    <!--
      <script async="" defer="" data-domain="donut.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
    -->

  </body>
</html>
